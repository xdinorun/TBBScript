-- Key System Setup
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local HttpService = game:GetService("HttpService")
local player = Players.LocalPlayer

-- GUI setup for key input
local screenGui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
screenGui.Name = "KeySystemUI"
screenGui.ResetOnSpawn = false

local keyFrame = Instance.new("Frame", screenGui)
keyFrame.Size = UDim2.new(0, 300, 0, 150)
keyFrame.Position = UDim2.new(0.5, -150, 0.5, -75)
keyFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)

local keyBox = Instance.new("TextBox", keyFrame)
keyBox.Size = UDim2.new(0, 260, 0, 40)
keyBox.Position = UDim2.new(0, 20, 0, 20)
keyBox.PlaceholderText = "Enter Key Here"
keyBox.Text = ""
keyBox.TextColor3 = Color3.fromRGB(255, 255, 255)
keyBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)

local statusLabel = Instance.new("TextLabel", keyFrame)
statusLabel.Size = UDim2.new(0, 260, 0, 20)
statusLabel.Position = UDim2.new(0, 20, 0, 70)
statusLabel.TextColor3 = Color3.fromRGB(255, 0, 0)
statusLabel.Text = ""
statusLabel.BackgroundTransparency = 1

local submitButton = Instance.new("TextButton", keyFrame)
submitButton.Size = UDim2.new(0, 260, 0, 30)
submitButton.Position = UDim2.new(0, 20, 0, 100)
submitButton.Text = "Submit Key"
submitButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)

-- Key check
local correctKey = ""
local success, result = pcall(function()
    return game:HttpGet("https://raw.githubusercontent.com/xdinorun/TBBScript/refs/heads/main/autoupdatekey")
end)
if success then
    correctKey = result:match("%S+") or ""
else
    statusLabel.Text = "Failed to load key."
end

local function unlockScript()
    screenGui:Destroy()

    -- Begin Main Script

    -- GUI setup
    local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
    gui.Name = "AutoControlUI"
    gui.ResetOnSpawn = false

    -- Unit Button
    local unitButton = Instance.new("TextButton", gui)
    unitButton.Size = UDim2.new(0, 120, 0, 40)
    unitButton.Position = UDim2.new(1, -130, 0, 100)
    unitButton.Text = "Unit: OFF"
    unitButton.BackgroundColor3 = Color3.fromRGB(255, 255, 0)

    local unitRunning = false
    unitButton.MouseButton1Click:Connect(function()
        unitRunning = not unitRunning
        unitButton.Text = unitRunning and "Unit: ON" or "Unit: OFF"
    end)

    -- Slot Input Box
    local slotBox = Instance.new("TextBox", gui)
    slotBox.Size = UDim2.new(0, 120, 0, 30)
    slotBox.Position = UDim2.new(1, -130, 0, 60)
    slotBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    slotBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    slotBox.TextSize = 14
    slotBox.Text = "8"
    slotBox.ClearTextOnFocus = false

    -- Replay Button
    local replayButton = Instance.new("TextButton", gui)
    replayButton.Size = UDim2.new(0, 120, 0, 40)
    replayButton.Position = UDim2.new(1, -130, 0, 150)
    replayButton.Text = "Replay: OFF"
    replayButton.BackgroundColor3 = Color3.fromRGB(0, 200, 255)

    local autoReplay = false
    replayButton.MouseButton1Click:Connect(function()
        autoReplay = not autoReplay
        replayButton.Text = autoReplay and "Replay: ON" or "Replay: OFF"
    end)

    -- Replay Function
    local allowReplay = true
    local function tryReplay()
        if not allowReplay then return end
        local gui = player:FindFirstChild("PlayerGui")
        if not gui then return end

        local paths = {
            "PlayerGui.EndScreen.WinScreen.Normal.Buttons.Retry",
            "PlayerGui.EndScreen.LoseScreen.Normal.Buttons.Retry"
        }

        for _, path in ipairs(paths) do
            local target = player
            for part in string.gmatch(path, "[^.]+") do
                target = target:FindFirstChild(part)
                if not target then break end
            end

            if target then
                for _, conn in ipairs(getconnections(target.Activated)) do
                    if typeof(conn.Function) == "function" then
                        task.spawn(conn.Function)
                        allowReplay = false
                        task.delay(3, function()
                            allowReplay = true
                        end)
                        break
                    end
                end
            end
        end
    end

    -- Auto Replay Loop
    task.spawn(function()
        while true do
            if autoReplay then
                tryReplay()
            end
            task.wait(1)
        end
    end)

    -- Auto Spawn Loop
    task.spawn(function()
        while true do
            if unitRunning then
                local slot = tonumber(slotBox.Text)
                if slot and slot >= 1 and slot <= 8 then
                    local args = { [1] = "Slot" .. tostring(slot) }
                    ReplicatedStorage:WaitForChild("Events"):WaitForChild("RemoteFunction"):WaitForChild("PlayerSpawn"):InvokeServer(unpack(args))
                end
            end
            task.wait(1)
        end
    end)
end

submitButton.MouseButton1Click:Connect(function()
    if keyBox.Text == correctKey then
        unlockScript()
    else
        statusLabel.Text = "Invalid key. Try again."
    end
end)
